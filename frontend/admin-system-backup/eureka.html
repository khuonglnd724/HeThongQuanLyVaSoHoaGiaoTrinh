<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eureka Registry - SMD Admin</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <div class="app-container">
        <aside class="sidebar">
            <div class="sidebar-header">
                <h2>SMD Admin</h2>
            </div>
            <nav class="sidebar-nav">
                <a href="dashboard.html" class="nav-item">
                    <span class="icon">üìä</span>
                    <span>Dashboard</span>
                </a>
                <a href="services.html" class="nav-item">
                    <span class="icon">‚öôÔ∏è</span>
                    <span>Services</span>
                </a>
                <a href="eureka.html" class="nav-item active">
                    <span class="icon">üîç</span>
                    <span>Eureka Registry</span>
                </a>
                <a href="config-server.html" class="nav-item">
                    <span class="icon">üìù</span>
                    <span>Config Server</span>
                </a>
                <div class="nav-divider"></div>
                <a href="users.html" class="nav-item">
                    <span class="icon">üë•</span>
                    <span>User Management</span>
                </a>
                <a href="roles.html" class="nav-item">
                    <span class="icon">üîê</span>
                    <span>Roles & Permissions</span>
                </a>
            </nav>
            <div class="sidebar-footer">
                <button id="logoutBtn" class="btn btn-logout">
                    <span class="icon">üö™</span>
                    <span>Logout</span>
                </button>
            </div>
        </aside>

        <main class="main-content">
            <header class="header">
                <h1>Eureka Service Registry</h1>
                <div class="header-actions">
                    <a href="http://localhost:8761" target="_blank" class="btn btn-secondary">
                        Open Eureka UI
                    </a>
                    <button id="refreshBtn" class="btn btn-icon">üîÑ</button>
                </div>
            </header>

            <div class="content">
                <div class="section">
                    <h2>Registry Status</h2>
                    <div id="registryStatus" class="registry-status">
                        <div class="status-item">
                            <strong>Registered Instances:</strong>
                            <span id="instanceCount">-</span>
                        </div>
                        <div class="status-item">
                            <strong>Applications:</strong>
                            <span id="appCount">-</span>
                        </div>
                        <div class="status-item">
                            <strong>Last Sync:</strong>
                            <span id="lastSync">-</span>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <h2>Applications</h2>
                    <div id="applicationsList" class="applications-list">
                        <div class="loading">Loading applications...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="js/common.js"></script>
    <script src="js/api.js"></script>
    <script>
        // Eureka page specific logic
        async function loadEurekaData() {
            try {
                const data = await fetchEurekaApps();
                
                if (data && data.applications && data.applications.application) {
                    const apps = Array.isArray(data.applications.application) 
                        ? data.applications.application 
                        : [data.applications.application];
                    
                    const totalInstances = apps.reduce((sum, app) => {
                        const instances = Array.isArray(app.instance) ? app.instance : [app.instance];
                        return sum + instances.length;
                    }, 0);
                    
                    document.getElementById('instanceCount').textContent = totalInstances;
                    document.getElementById('appCount').textContent = apps.length;
                    document.getElementById('lastSync').textContent = new Date().toLocaleString();
                    
                    renderApplications(apps);
                }
            } catch (error) {
                console.error('Error loading Eureka data:', error);
                document.getElementById('applicationsList').innerHTML = 
                    '<div class="error">Failed to load applications</div>';
            }
        }

        function renderApplications(apps) {
            const container = document.getElementById('applicationsList');
            container.innerHTML = apps.map(app => {
                const instances = Array.isArray(app.instance) ? app.instance : [app.instance];
                return `
                    <div class="app-card">
                        <h3>${app.name}</h3>
                        <div class="instances-list">
                            ${instances.map(inst => `
                                <div class="instance-item">
                                    <span class="status-badge status-${inst.status.toLowerCase()}">${inst.status}</span>
                                    <span>${inst.hostName}:${inst.port.$}</span>
                                    <span class="instance-id">${inst.instanceId}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        document.getElementById('refreshBtn').addEventListener('click', loadEurekaData);
        checkAuth();
        loadEurekaData();
        setInterval(loadEurekaData, 15000);
    </script>
</body>
</html>